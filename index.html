<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="author" content="FEI YUAN">
  <meta name="email" content="fei.yuan@bcm.edu">

  <title>Enrichment Profile Visualizer</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <!-- Dropzone CSS -->
  <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
  <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>

<body class="container-fluid bg-light">
  <!-- Title and toolbar -->
  <div class="row py-2 align-items-center g-2 flex-shrink-0">
    <!--Title & help-->
    <div
      class="col-sm-2 col-md-1 d-flex align-items-center justify-content-start">
      <h1 class="h3 mb-0">EPV</h1>
      <button type="button" class="btn btn-light py-0 ms-1" title="Help"
              data-bs-toggle="modal" data-bs-target="#helpModal">
        <i class="bi bi-question-circle"></i>
      </button>
    </div>

    <!--Switchers-->
    <div class="col-9 col-sm-10 col-md-4 col-lg-5 d-flex justify-content-end" id="switchers">
      <button type="button" class="btn btn-light position-relative py-0 px-2 disabled" id="btnHitsModal"
              data-bs-toggle="modal" data-bs-target="#hitsModal" title="Candidate Hits">
        <i class="bi bi-bag"></i>
        <span class="position-absolute top-0 start-100 translate-middle">
          <span class="badge rounded-pill bg-danger text-small" id="numHits"></span>
          <span class="visually-hidden">Number of candidate hits</span>
        </span>
      </button>
      <button type="button" class="btn btn-light py-0 ms-5" title="Set equal axes (1:1)" id="btnEqualAxis">
        <i class="bi bi-graph-up"></i>
      </button>
      <button type="button" class="btn btn-light py-0 ms-2" title="Top Hits"
              data-bs-toggle="modal" data-bs-target="#topHitsModal">
        <i class="bi bi-table"></i>
      </button>
      <button type="button" class="btn btn-light py-0 ms-2 me-2" title="Config"
              data-bs-toggle="modal" data-bs-target="#configModal">
        <i class="bi bi-gear"></i>
      </button>
    </div>

    <!--Selectors-->
    <div class="col-12 col-sm-12 col-md-7 col-lg-6 d-flex justify-content-end d-none" id="selectors">
      <div id="data-selector" class="btn-group d-flex w-100" role="group" aria-label="X / Library / Y">
        <div class="btn-group flex-fill" role="group">
          <button type="button" class="btn btn-outline-secondary dropdown-toggle w-100 text-start rounded-start-pill"
                  data-bs-toggle="dropdown" aria-expanded="false" id="btnX">X</button>
          <ul class="dropdown-menu" id="xSel">
          </ul>
        </div>

        <div class="btn-group flex-fill" role="group">
          <button type="button" class="btn btn-outline-secondary dropdown-toggle w-100"
                  data-bs-toggle="dropdown" aria-expanded="false" id="btnLibrary">Library</button>
          <ul class="dropdown-menu" id="librarySel">
          </ul>
        </div>

        <div class="btn-group flex-fill" role="group">
          <button type="button" class="btn btn-outline-secondary dropdown-toggle w-100 text-end rounded-end-pill"
                  data-bs-toggle="dropdown" aria-expanded="false" id="btnY">Y</button>
          <ul class="dropdown-menu" id="ySel">
          </ul>
        </div>
      </div>
    </div>

  </div>

  <!--File upload panel-->
  <div class="container bg-white align-content-center d-none" id="uploadPanel">
    <div class="upload-card py-3 rounded">
      <h2 class="h5 text-center mb-2">Load enrichment data</h2>
      <p class="text-center text-secondary mb-4">from a <strong>.csv</strong> file with a header row to visualize the profile</p>

      <form id="dropzone" class="dropzone dz-theme p-5 text-center"
            aria-label="Upload CSV by click or drag-and-drop" action="#">
        <div class="dz-message align-middle">
          <div class="dz-title fw-semibold fs-5">Drag &amp; Drop File</div>
          <div class="dz-sub text-secondary">â€¦ or click here to choose one from your computer</div>
        </div>
      </form>
    </div>
  </div>

  <!--Chart panel-->
  <div id="chartContainer">
    <div id="chartPanel" class="w-100 h-100"></div>
  </div>

  <!-- Help Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="helpModalLabel">Enrichment Profile Visualizer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h1>Enrichment Profile Visualizer</h1>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hit Modal -->
  <div class="modal fade" id="hitsModal" tabindex="-1" aria-labelledby="hitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bagModalLabel">Candidate Hits</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="hitsTable"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Hits Modal -->
  <div class="modal fade" id="topHitsModal" tabindex="-1" aria-labelledby="topHitsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="topHitsModalLabel">AI Flagged Top Hits</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="topHitsTable"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Config Modal -->
  <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="configModalLabel">Visualizer Config</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="" class="row g-3">
            <!-- Typography -->
            <div class="col-12 col-md-7">
              <label for="fontFamily" class="form-label fw-bold">Font</label>
              <select id="fontFamily" class="form-select">
                <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">System UI</option>
                <option value="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">Inter</option>
                <option value="Roboto, Helvetica, Arial, sans-serif">Roboto</option>
                <option value="Arial, Helvetica, sans-serif">Arial</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
              </select>
            </div>
            <div class="col-6 col-md-5">
              <label for="fontSize" class="form-label fw-bold">Font size (px)</label>
              <div class="input-group">
                <input id="fontSize" type="number" class="form-control" min="8" max="48" step="1" value="12">
                <span class="input-group-text">px</span>
              </div>
            </div>

            <div class="col-12 col-md-7">
              <label for="fontFamilyCC" class="form-label fw-bold">Compound Card Font</label>
              <select id="fontFamilyCC" class="form-select">
                <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">System UI</option>
                <option value="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">Inter</option>
                <option value="Roboto, Helvetica, Arial, sans-serif">Roboto</option>
                <option value="Arial, Helvetica, sans-serif">Arial</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
              </select>
            </div>
            <div class="col-6 col-md-5">
              <label for="fontSizeCC" class="form-label fw-bold">Compound Card Font size (px)</label>
              <div class="input-group">
                <input id="fontSizeCC" type="number" class="form-control" min="8" max="48" step="1" value="10">
                <span class="input-group-text">px</span>
              </div>
            </div>

            <!-- Structure rendering toggles -->
            <div class="col-12">
              <label class="form-label mb-1 fw-bold">Structure rendering</label>
              <div class="row gy-2">
                <div class="col-6 col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="renderBB1" checked>
                    <label class="form-check-label" for="renderBB1">BB1</label>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="renderBB2" checked>
                    <label class="form-check-label" for="renderBB2">BB2</label>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="renderBB3" checked>
                    <label class="form-check-label" for="renderBB3">BB3</label>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="renderSmiles" checked>
                    <label class="form-check-label" for="renderSmiles">SMILES</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Structure size -->
            <div class="col-12 col-md-4">
              <label for="structWidth" class="form-label fw-bold">Structure width (px)</label>
              <div class="input-group">
                <input id="structWidth" type="number" class="form-control" min="50" max="500" step="10" value="175">
                <span class="input-group-text">px</span>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <label for="structHeight" class="form-label fw-bold">Structure height (px)</label>
              <div class="input-group">
                <input id="structHeight" type="number" class="form-control" min="50" max="500" step="10" value="100">
                <span class="input-group-text">px</span>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <label for="structHeight" class="form-label fw-bold">Number of top hits per library</label>
              <div class="input-group">
                <input id="nTopHits" type="number" class="form-control" min="1" max="20" step="1" value="5">
              </div>
            </div>

            <!-- Color configuration -->
            <div class="col-12">
              <label class="form-label d-block fw-bold">Colors</label>
              <div class="row g-2">
                <div class="col-4">
                  <div class="d-flex align-items-center">
                    <label for="colorMono" class="form-label mb-0 me-2">Mono-sython</label>
                    <input id="colorMono" type="color" class="form-control form-control-color flex-grow-1 w-auto" value="#0000ad"
                           title="Pick color for mono-sython">
                  </div>
                </div>

                <div class="col-4">
                  <div class="d-flex align-items-center">
                    <label for="colorDi" class="form-label mb-0 me-2">Di-sython</label>
                    <input id="colorDi" type="color" class="form-control form-control-color flex-grow-1 w-auto" value="#00ff33"
                           title="Pick color for di-sython">
                  </div>
                </div>

                <div class="col-4">
                  <div class="d-flex align-items-center">
                    <label for="colorTri" class="form-label mb-0 me-2">Tri-sython</label>
                    <input id="colorTri" type="color" class="form-control form-control-color flex-grow-1 w-auto" value="#faaf05"
                           title="Pick color for tri-sython">
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="btnSaveConfig" class="btn btn-primary">Apply</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Encoding Modal -->
  <div class="modal fade" id="encodingModal" tabindex="-1" aria-labelledby="encodingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><span id="encodingModalTitle"></span> Encoding Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!--SMILES cards-->
          <div class="row row-cols-1 row-cols-md-4 g-2" id="encodingDetails">
            <div class="col">
              <div class="card" id="encodingModalBB1">
                <svg id="" class="smiles-svg" viewBox="0 0 240 100" data-smiles=""></svg>
              </div>
            </div>
            <div class="col">
              <div class="card" id="encodingModalBB2">
                <svg id="" class="smiles-svg" viewBox="0 0 125 125" data-smiles=""></svg>
              </div>
            </div>
            <div class="col">
              <div class="card" id="encodingModalBB3">
                <svg id="" class="smiles-svg" viewBox="0 0 125 125" data-smiles=""></svg>
              </div>
            </div>
            <div class="col">
              <div class="card" id="encodingModalSMILES">
                <svg id="" class="smiles-svg" viewBox="0 0 125 125" data-smiles=""></svg>
              </div>
            </div>
          </div>
          <!-- Count Score Table -->
        </div>
<!--        <div class="modal-footer">-->
<!--          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>-->
<!--          <button type="button" class="btn btn-primary">Save changes</button>-->
<!--        </div>-->
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
    defer></script>
  <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2/dist/pako.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-3.1.0.min.js" charset="utf-8"></script>
  <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
  <script type="text/javascript" src="smiles-render.js"></script>
  <script type="text/javascript" src="visualizer.js"></script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
      Visualizer.init({url: 'data.tsv.gz'})
    })
  </script>
</body>
</html>